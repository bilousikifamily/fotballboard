# –°–∏—Å—Ç–µ–º–∞ –ø–æ–≥–æ–¥–∏

## 1. –ó–∞–≥–∞–ª—å–Ω–∞ —Å—Ö–µ–º–∞
- **–î–∞–Ω—ñ –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ —Ç–∞–±–ª–∏—Ü—ñ `matches`**: –ø–æ–ª—è `rain_probability`, `weather_condition`, `weather_temp_c`, `weather_timezone`, `weather_fetched_at` —Ç—Ä–∏–º–∞—é—Ç—å –æ—Å—Ç–∞–Ω–Ω—ñ–π –ø—Ä–æ–≥–Ω–æ–∑ —ñ –ø–æ—Ç—Ä—ñ–±–Ω—ñ —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥—É (–¥–∏–≤. `api/src/handlers.ts`, `web/src/types.ts`).
- **–ü–æ–≥–æ–¥–∏–Ω–Ω–∏–π –ø—Ä–æ–≥–Ω–æ–∑ –±–µ—Ä–µ—Ç—å—Å—è –∞–±–æ –∑ –∫–µ—à–∞, –∞–±–æ –∑ API** —ñ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è –¥–æ —Ç–∞–±–ª–∏—Ü—ñ –ª–∏—à–µ –∫–æ–ª–∏ –Ω–µ —î ¬´–∑–∞—Å—Ç–∞—Ä—ñ–ª–∏–º¬ª. –ü—ñ–∑–Ω—ñ—à—ñ –∑–∞–ø–∏—Ç–∏ –ø–æ–∫–∞–∑—É—é—Ç—å –∑–∞–∫–µ—à–æ–≤–∞–Ω—É –≤–µ—Ä—Å—ñ—é, –ø–æ–∫–∏ –¥–∞–Ω—ñ —â–µ –≤–∞–ª—ñ–¥–Ω—ñ.
- **–¶—è —Å–∏—Å—Ç–µ–º–∞ –ø–æ–∫—Ä–∏–≤–∞—î –¥–≤–∞ —à–ª—è—Ö–∏**: 
  - –°–∏–Ω—Ö—Ä–æ–Ω–Ω–∏–π `GET /api/matches/weather?match_id=‚Ä¶` –¥–ª—è –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω–æ–≥–æ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è (–ø—Ä–∞—Ü—é—î –∑ `initData` Telegram, –º–æ–∂–Ω–∞ –¥–æ–¥–∞—Ç–∏ `debug=1`).
  - –§–æ–Ω–æ–≤–µ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è —á–µ—Ä–µ–∑ `handleWeatherRefresh`, —è–∫–µ –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —É `scheduled` handler (`ctx.waitUntil(handleWeatherRefresh(env))` –≤ `api/src/handlers.ts`).

## 2. –ë–µ–∫–µ–Ω–¥: —è–∫ –∑–±–∏—Ä–∞—î—Ç—å—Å—è –ø—Ä–æ–≥–Ω–æ–∑

### 2.1. –ï–Ω–¥–ø–æ—ñ–Ω—Ç `/api/matches/weather`
- –ü—Ä–∏–π–º–∞—î `match_id` —ñ –∑–∞–≥–æ–ª–æ–≤–æ–∫ `initData`; –ø–æ–≤–µ—Ä—Ç–∞—î `rain_probability`, `weather_condition`, `weather_temp_c`, `weather_timezone`. –í —Ä–∞–∑—ñ `debug=1` —Ç–∞–∫–æ–∂ –≤—ñ–¥–¥–∞—î `WeatherDebugInfo` –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –∫–µ—à, —Å—Ç–∞—Ç—É—Å API —ñ —Ç–∞–π–º—Å—Ç–µ–º–ø–∏.
- –î–ª—è –º–∞—Ç—á—É –≤–∏–∫–ª–∏–∫–∞—î `fetchMatchWeatherDetailed`, —è–∫–∏–π –æ—Ä–∫–µ—Å—Ç—Ä—É—î –≤–µ—Å—å –ª–∞–Ω—Ü—é–∂–æ–∫ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è / –∫–µ—à—É–≤–∞–Ω–Ω—è.

### 2.2. `fetchMatchWeatherDetailed`
- –ü–µ—Ä–µ–≤—ñ—Ä—è—î `kickoff_at`; —è–∫—â–æ –±—Ä–∞–∫—É—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç ‚Äî –∑–∞–ø—É—Å–∫–∞—î `geocodeCity` —á–µ—Ä–µ–∑ `https://geocoding-api.open-meteo.com/v1/search`.
- –ó–±–µ—Ä—ñ–≥–∞—î –∑–Ω–∞–π–¥–µ–Ω—ñ `lat/lon` —É –ë–î (`saveMatchCoordinates`), –ø–æ–≤–µ—Ä—Ç–∞—î `missing_location`, `bad_kickoff` –∞–±–æ `api_error`.
- –í–∏–∫–ª–∏–∫–∞—î `fetchWeatherForecast` —ñ–∑ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∞–º–∏ —Ç–∞ —Ç–æ—á–Ω–∏–º UTC-–≥–æ–¥–∏–Ω–æ—é (`getUtcHourBucket` –æ–∫—Ä—É–≥–ª—é—î –¥–æ –Ω–∞–π–±–ª–∏–∂—á–æ—ó –≥–æ–¥–∏–Ω–∏, —Ö–≤–∏–ª–∏–Ω–∏ >=30 –æ–∫—Ä—É–≥–ª—é—é—Ç—å—Å—è –≤–≥–æ—Ä—É).
- –Ø–∫—â–æ –ø—Ä–æ–≥–Ω–æ–∑ –ø–æ–≤–µ—Ä–Ω—É–≤—Å—è —É—Å–ø—ñ—à–Ω–æ —ñ –Ω–µ —î `isStale`, –æ–Ω–æ–≤–ª—é—î `matches` (`saveMatchWeatherCache`) —ñ –ø–æ–≤–µ—Ä—Ç–∞—î —Å—Ç—Ä—É–∫—Ç—É—Ä—É `WeatherDetailedResult` (–≤–∫–ª—é—á–Ω–æ –∑ `debug`).

### 2.3. –î–∂–µ—Ä–µ–ª–∞: `open-meteo` + `weatherapi`
- –û—Å–Ω–æ–≤–Ω–∏–π –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫: `open-meteo` (—á–µ—Ä–µ–∑ `fetchOpenMeteoProbability`). –ó–∞–ø–∏—Ç: `hourly=precipitation_probability,weathercode,temperature_2m`, `timezone=UTC`, `start_date`/`end_date` –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –¥–Ω—é, `apiTime` —Ç–æ—á–∫–∞ —á–∞—Å—É. –û–±—Ä–æ–±–∫–∞: `findClosestTimeIndex`, –Ω–æ—Ä–º–∞–ª—ñ–∑–∞—Ü—ñ—è –ø–æ–≥–æ–¥–Ω–æ–≥–æ –∫–æ–¥—É –≤ `normalizeOpenMeteoCondition`.
- –§–æ–ª–±–µ–∫: `weatherapi.com` (`fetchWeatherApiProbability`) –∑–∞–ø—É—Å–∫–∞—î—Ç—å—Å—è —Ç—ñ–ª—å–∫–∏ —è–∫—â–æ –∑–∞–¥–∞–Ω—ñ `WEATHERAPI_KEY` (—ñ –∫–ª—é—á –≤ `env`). –û–±–º–µ–∂–µ–Ω–Ω—è: –ø—Ä–æ–≥–Ω–æ–∑–∏ –¥–æ 10 –¥–Ω—ñ–≤ (`getDaysAheadUtc`), –ø–æ–≤–µ—Ä—Ç–∞—î `chance_of_rain`, `temp_c`, `condition`. –¢–µ–∫—Å—Ç–æ–≤–µ –ø–æ–ª–µ —Ç–∞–∫–æ–∂ –Ω–æ—Ä–º–∞–ª—ñ–∑—É—î—Ç—å—Å—è (`normalizeWeatherApiCondition`) –¥–ª—è —ñ–∫–æ–Ω–æ–∫.
- –õ–æ–≥—ñ–∫–∞ `fetchWeatherForecast` —Å–ø–æ—á–∞—Ç–∫—É –±–µ—Ä–µ `open-meteo`, –ø–æ—Ç—ñ–º, —è–∫—â–æ —î `WEATHERAPI_KEY`, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ñ–æ–ª–±–µ–∫, –∫–æ–ª–∏:
  - –æ—Å–Ω–æ–≤–Ω–∏–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –±—Ä–∞–∫–æ–≤–∞–Ω–∏–π (—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞/—Ç–∞–π–º–∑–æ–Ω–∞) –∞–±–æ `ok=false`, –∞–±–æ `isStale`.
  - –∞–±–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ –¥–æ–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —á–∞—Å/—Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –∑ —Ñ–æ–ª–±–µ–∫–∞ (–∫–æ–ª–∏ `needsTimezone` –∞–±–æ `needsTemp`).
  - –í—ñ–¥–¥–∞—î —Å–ø–æ—á–∞—Ç–∫—É –ø—Ä–∞—Ü—é—é—á–∏–π, –∞ —è–∫—â–æ –æ–±–∏–¥–≤–∞ –≤—ñ–¥–º–æ–≤–∏–ª–∏ ‚Äî `primary`.

### 2.4. –ö–µ—à—É–≤–∞–Ω–Ω—è –π –ª—ñ–º—ñ—Ç–∏
- `weatherCache` (`Map<string, WeatherCacheEntry>`) –∑–±–µ—Ä—ñ–≥–∞—î –∑–Ω–∞—á–µ–Ω–Ω—è –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫–ª—é—á–∞ `weather:{provider}:{lat}:{lon}:{utcHour}:{units}:{lang}` (–∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –æ–∫—Ä—É–≥–ª–µ–Ω—ñ –¥–æ 4 –∑–Ω–∞–∫—ñ–≤). –î–æ –∫–µ—à–∞ –ø–æ—Ç—Ä–∞–ø–ª—è—é—Ç—å —è–∫ —É—Å–ø—ñ—à–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è, —Ç–∞–∫ —ñ –ø–æ–º–∏–ª–∫–∏ (`isError`).
- `expiresAt` (–∑–∞ –∑–∞–º–æ–≤—á–∞–Ω–Ω—è–º 60 —Ö–≤) —ñ `staleUntil` (24h) –∫–æ–Ω—Ç—Ä–æ–ª—é—é—Ç—å—Å—è —Ñ—É–Ω–∫—Ü—ñ—è–º–∏ `getWeatherCacheTtlMin` —Ç–∞ `getWeatherStaleTtlHours`. –Ø–∫—â–æ TTL –≤–∏—á–µ—Ä–ø–∞–Ω–æ ‚Äî –ø–æ—Ç—Ä—ñ–±–µ–Ω –Ω–æ–≤–∏–π –≤–∏–∫–ª–∏–∫.
- –Ø–∫—â–æ –æ—Å—Ç–∞–Ω–Ω—ñ–π –∑–∞–ø–∏—Ç –Ω–µ –∑–∞–≤–µ—Ä—à–∏–≤—Å—è (`weatherInFlight`), –Ω–æ–≤—ñ –≤–∏–∫–ª–∏–∫–∏ —á–µ–∫–∞—é—Ç—å –Ω–∞ —Ä–µ–∑—É–ª—å—Ç–∞—Ç, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—é–≤–∞–Ω–Ω—è.
- `weatherRateLimiter` –æ–±–º–µ–∂—É—î –∑–∞–ø–∏—Ç–∏ –Ω–∞ —Ä—ñ–≤–Ω—ñ –ø—Ä–æ—Ü–µ—Å—É (–Ω–∞ 5 —Å–µ–∫—É–Ω–¥ —ñ –∑–∞ —Ö–≤–∏–ª–∏–Ω—É) –∑ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞–º–∏ `WEATHER_RATE_LIMIT_PER_5S` —Ç–∞ `WEATHER_RATE_LIMIT_PER_MIN` (—Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–æ 1/5s —ñ 10/min). –Ø–∫—â–æ –ª—ñ–º—ñ—Ç –ø–µ—Ä–µ–≤–∏—â–µ–Ω–æ, –≤—ñ–¥–¥–∞—î—Ç—å—Å—è `stale` –∞–±–æ `rate_limited`.
- –ü—Ä–∏ `HTTP 429` –æ–Ω–æ–≤–ª—é—î—Ç—å—Å—è `weatherCooldownUntilMs`, —â–æ–± –Ω–∞—Å—Ç—É–ø–Ω—ñ –∑–∞–ø–∏—Ç–∏ —á–µ–∫–∞–ª–∏ (–º–∞–∫—Å–∏–º—É–º –¥–æ `WEATHER_RETRY_DELAY_CAP_MS`).
- –ü–æ–≤—Ç–æ—Ä–Ω—ñ —Å–ø—Ä–æ–±–∏ (`computeRetryDelayMs`) –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å –µ–∫—Å–ø–æ–Ω–µ–Ω—Ü—ñ–∞–ª—å–Ω–µ –∑–±—ñ–ª—å—à–µ–Ω–Ω—è –∑ –¥–∂—ñ—Ç—Ç–µ—Ä–æ–º, –±–∞–∑–æ–≤–µ `WEATHER_RETRY_BASE_DELAY_MS`, –º–∞–∫—Å–∏–º–∞–ª—å–Ω–µ `WEATHER_RETRY_DELAY_CAP_MS`, —ñ –º–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä—ñ–≤ ‚Äî `WEATHER_RETRY_MAX_ATTEMPTS` (–º—ñ–Ω—ñ–º—É–º 1, –∑–∞ –∑–∞–º–æ–≤—á–∞–Ω–Ω—è–º 4).

### 2.5. –î–æ–ø–æ–º—ñ–∂–Ω—ñ —É—Ç–∏–ª—ñ—Ç–∏
- `geocodeCity` (open-meteo) –ø–æ–≤–µ—Ä—Ç–∞—î `lat`, `lon` –∞–±–æ —Å—Ç–∞—Ç—É—Å –ø–æ–º–∏–ª–∫–∏, –∑–±–µ—Ä—ñ–≥–∞—î –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.
- `findClosestTimeIndex`, `findClosestHourEntry` –≤–∏–±–∏—Ä–∞—é—Ç—å –≥–æ–¥–∏–Ω—É –≤ –º–∞—Å–∏–≤—ñ –¥–∞–Ω–∏—Ö.
- `normalizeWeatherApiCondition`/`normalizeOpenMeteoCondition` –ø—Ä–∏–≤–æ–¥—è—Ç—å –∫–æ–¥–∏ –¥–æ –æ–¥–Ω–æ–≥–æ –Ω–∞–±–æ—Ä—É (`clear`, `cloudy`, `rain`, `snow`, `thunderstorm`, `fog`, `partly_cloudy`).
- `parseRetryAfterSeconds` —ñ `shouldRetryWeather` —É–ø—Ä–∞–≤–ª—è—é—Ç—å –ø–æ–≤—Ç–æ—Ä–Ω–∏–º–∏ –≤–∏–∫–ª–∏–∫–∞–º–∏ –¥–ª—è —Å—Ç–∞—Ç—É—Å—ñ–≤ `429/408/502/503/504`.

### 2.6. –û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤ –±–∞–∑—ñ
- –Ø–∫—â–æ –ø—Ä–æ–≥–Ω–æ–∑ –≤–∞–ª—ñ–¥–Ω–∏–π (`forecast.ok && !forecast.isStale`), `saveMatchWeatherCache` –∑–∞–ø–∏—Å—É—î `rain_probability`, `weather_condition`, `weather_temp_c` –π `weather_timezone` –∑ —á–∞—Å–æ–≤–æ—é –º—ñ—Ç–∫–æ—é `weather_fetched_at`.
- `listMatchesForWeatherRefresh` –ø—ñ–¥–±–∏—Ä–∞—î –º–∞—Ç—á—ñ –∑—ñ —Å—Ç–∞—Ç—É—Å–æ–º `scheduled`, —É —è–∫–∏—Ö `weather_fetched_at` –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞–±–æ —Å—Ç–∞—Ä—à–∏–π –∑–∞ `WEATHER_DB_REFRESH_MIN` —Ö–≤–∏–ª–∏–Ω, —ñ –∑–Ω–∞—Ö–æ–¥—è—Ç—å—Å—è –≤ –º–µ–∂–∞—Ö `WEATHER_DB_LOOKAHEAD_H` –≥–æ–¥–∏–Ω (`limit` ‚Äî `WEATHER_DB_REFRESH_LIMIT` –∑–∞–ø–∏—Å—ñ–≤).
- `handleWeatherRefresh` –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è —É `scheduled` event (—Ç—Ä–∏–≥–µ—Ä —á–µ—Ä–µ–∑ `ctx.waitUntil`) —Ç–∞ –ø–æ—Å–ª—ñ–¥–æ–≤–Ω–æ –≤–∏–∫–æ–Ω—É—î `fetchMatchWeatherDetailed` –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –º–∞—Ç—á—É.

## 3. –§—Ä–æ–Ω—Ç–µ–Ω–¥: —è–∫ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î—Ç—å—Å—è –ø–æ–≥–æ–¥–∞
- `web/src/api/matches.ts` –º–∞—î `fetchMatchWeather`, —è–∫–∏–π —Ä–æ–±–∏—Ç—å –≤–∏–∫–ª–∏–∫ –¥–æ `/api/matches/weather` –∑ `authHeaders` (—á–µ—Ä–µ–∑ `initData` –∑ Telegram Web App). –¶–µ –¥–∞—î —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∞–º (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∫–Ω–æ–ø–∫–∞–º –≤ –∞–¥–º—ñ–Ω—Ü—ñ) –∑–º–æ–≥—É –≤—Ä—É—á–Ω—É –æ–Ω–æ–≤–∏—Ç–∏ –ø—Ä–æ–≥–Ω–æ–∑.
- `web/src/types.ts` –≤ —Å—Ç—Ä—É–∫—Ç—É—Ä—ñ `Match` —ñ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ `MatchesResponse` –≤–∏–∑–Ω–∞—á–∞—î –ø–æ–ª—è `rain_probability`, `weather_condition`, `weather_temp_c`, `weather_timezone`. `matches` –æ—Ç—Ä–∏–º—É—é—Ç—å—Å—è —á–µ—Ä–µ–∑ `fetchMatches` / `fetchPendingMatches`.
- `web/src/screens/matches.ts`:
  - `renderMatchCard` –ø–æ–∫–∞–∑—É—î `match.weather_temp_c` (—á–µ—Ä–µ–∑ `formatTemperature`) —ñ –ø—ñ–¥–∫–∞–∑–∫—É –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ —á–∞—Å—É (`formatTimeInZone` –∑ `weather_timezone` –∞–±–æ `resolveMatchTimezone`, —è–∫–µ –ø–∞–¥‚Äô—î –Ω–∞ –ª—ñ–≥–æ–≤—ñ —á–∞—Å–æ–≤—ñ –ø–æ—è—Å–∏).
  - `renderMatchCard` —Ç–∞–∫–æ–∂ –±—É–¥—É—î –ø–æ–ª–æ—Å—É –¥–æ—â—É: `normalizeRainProbability` –æ–±–º–µ–∂—É—î –ø—Ä–æ—Ü–µ–Ω—Ç 0‚Äë100, `getWeatherIcon` –æ–±–∏—Ä–∞—î —Å–º–∞–π–ª–∏–∫ (‚õàÔ∏è/üå®Ô∏è/üåßÔ∏è) —ñ –∑–∞–ø–æ–≤–Ω—é—î `width` —É `.match-weather-bar-fill`.
  - –í—Å—ñ —Ü—ñ –±–ª–æ–∫–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—é—Ç—å—Å—è –≤ –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ `renderMatchesList`, —Ç–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –±–∞—á–∞—Ç—å —à–≤–∏–¥–∫–∏–π –ø–æ–≥–ª—è–¥ –Ω–∞ –π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å –¥–æ—â—É —Ç–∞ —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—É –º–∞—Ç—á—É.
- –ê–¥–º—ñ–Ω–∫–∞ –±–∞—á–∏—Ç—å —Ç—ñ –∂ –∑–Ω–∞—á–µ–Ω–Ω—è, –±–æ `MatchesResponse` –ø–æ–≤–µ—Ä—Ç–∞—î —Ç—ñ –∂ –ø–æ–ª—è (—Ñ—É–Ω–∫—Ü—ñ—è `listMatches` –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ –≤–∏–±–∏—Ä–∞—î –∫–æ–ª–æ–Ω–∫–∏ `rain_probability`, `weather_condition`, `weather_temp_c`, `weather_timezone`).

## 4. –ü–∞—Ä–∞–º–µ—Ç—Ä–∏ –æ—Ç–æ—á–µ–Ω–Ω—è
| –ó–º—ñ–Ω–Ω–∞ | –ó–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º | –ü—Ä–∏–∑–Ω–∞—á–µ–Ω–Ω—è |
| --- | --- | --- |
| `WEATHER_CACHE_TTL_MIN` | `60` | –ß–∞—Å –∂–∏—Ç—Ç—è –∫–µ—à–æ–≤–∞–Ω–æ–≥–æ –∑–∞–ø–∏—Å—É –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–∏–º –∑–∞–ø–∏—Ç–æ–º |
| `WEATHER_STALE_TTL_H` | `24` | –Ø–∫ –¥–æ–≤–≥–æ –º–æ–∂–Ω–∞ –≤—ñ–¥–¥–∞–≤–∞—Ç–∏ `stale` –∫–µ—à, –ø–æ–∫–∏ –Ω–µ –æ–Ω–æ–≤–∏—Ç–∏ –ë–î |
| `WEATHER_RATE_LIMIT_PER_5S` | `1` | –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø–∏—Ç—ñ–≤ –¥–æ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö API –∑–∞ 5 —Å–µ–∫—É–Ω–¥ |
| `WEATHER_RATE_LIMIT_PER_MIN` | `10` | –ú–∞–∫—Å–∏–º—É–º –∑–∞–ø–∏—Ç—ñ–≤ –∑–∞ —Ö–≤–∏–ª–∏–Ω—É |
| `WEATHER_RETRY_MAX_ATTEMPTS` | `4` | –°–∫—ñ–ª—å–∫–∏ —Ä–∞–∑—ñ–≤ –ø—Ä–æ–±—É–≤–∞—Ç–∏ API –ø—Ä–∏ –ø–æ–º–∏–ª—Ü—ñ |
| `WEATHER_RETRY_BASE_DELAY_MS` | `1000` | –ë–∞–∑–æ–≤–∏–π `backoff` –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–æ–º |
| `WEATHER_RETRY_DELAY_CAP_MS` | `30000` | –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞ –∑–∞—Ç—Ä–∏–º–∫–∞ –º—ñ–∂ –ø–æ–≤—Ç–æ—Ä–Ω–∏–º–∏ —Å–ø—Ä–æ–±–∞–º–∏ |
| `WEATHER_DB_REFRESH_MIN` | `60` | –ú—ñ–Ω—ñ–º—É–º —Ö–≤–∏–ª–∏–Ω –ø–µ—Ä–µ–¥ –ø–æ–≤—Ç–æ—Ä–Ω–∏–º –∑–∞–ø–∏—Å–æ–º –ø–æ–≥–æ–¥–∏ –≤ –ë–î |
| `WEATHER_DB_LOOKAHEAD_H` | `24` | –°–∫—ñ–ª—å–∫–∏ –≥–æ–¥–∏–Ω —É–ø–µ—Ä–µ–¥ —Å–∫–∞–Ω—É–≤–∞—Ç–∏ –º–∞—Ç—á—ñ –¥–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è |
| `WEATHER_DB_REFRESH_LIMIT` | `24` | –°–∫—ñ–ª—å–∫–∏ –º–∞—Ç—á—ñ–≤ –æ–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø—É—Å–∫ `handleWeatherRefresh` |
| `WEATHERAPI_KEY` | (–≤—ñ–¥—Å—É—Ç–Ω—ñ–π) | –ö–ª—é—á –¥–ª—è `weatherapi.com`, –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è —Ñ–æ–ª–±–µ–∫—É —Ç–∞ —Ç–∞–π–º–∑–æ–Ω–∏ |
| `WEATHERAPI_BASE` | `https://api.weatherapi.com` | –ë–∞–∑–æ–≤–∞ URL –¥–ª—è —Ñ–æ–ª–±–µ–∫—É |

## 5. –î—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∞ —Ç–∞ –ª–æ–≥—É–≤–∞–Ω–Ω—è
- –õ–æ–≥–∏ `weather.fetch` (–≤ `logWeatherFetch`) –º—ñ—Å—Ç—è—Ç—å:
  - `cache_hit`, `cache_state`, `outbound_request`, `status_code`, `latency_ms`, `attempts`, `retry_after_sec`, `is_stale`.
- –ü—Ä–∏ –ø—Ä–æ–±–ª–µ–º–∞—Ö –∑ –≥–µ–æ–∫–æ–¥–∏–Ω–≥–æ–º –∞–±–æ –ø–∞—Ä—Å–∏–Ω–≥–æ–º (`Open-Meteo forecast parse error`, `WeatherAPI parse error`) –≤–∏–¥–∞—î—Ç—å—Å—è `console.warn`.
- `WeatherDetailedResult.debug` –ø–µ—Ä–µ–¥–∞—î—Ç—å—Å—è –≤ API (–∫–æ–ª–∏ `debug=1`), —Ç–æ–∂ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –º–æ–∂–µ –∑‚Äô—è—Å—É–≤–∞—Ç–∏, —á–∏ –ø—ñ—à–æ–≤ –∑–∞–ø–∏—Ç —É –∫–µ—à —ñ –∑–≤—ñ–¥–∫–∏ –ø—Ä–∏–π—à–æ–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç.
