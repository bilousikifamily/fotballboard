# Правила поведінки бота у груповому чаті

Цей документ описує всі умови та правила, за якими Telegram-бот модерує груповий чат.

## Структура чатів

Бот працює з трьома типами чатів:
- **Фракційні чати** (гілки обговорень):
  - `FACTION_CHAT_REAL` — чат фракції Реал Мадрид
  - `FACTION_CHAT_BARCA` — чат фракції Барселона
  - `FACTION_CHAT_MANCHESTER_UNITED` — чат фракції Манчестер Юнайтед
- **Загальний груповий чат**:
  - `FACTION_CHAT_GENERAL` — основний груповий чат

## Правила модерації

### 1. Модерація фракційних чатів

**Умова:** Депутат (користувач із обраною фракцією) пише у гілці фракції, до якої він не належить.

**Дія бота:**
- Видаляє повідомлення користувача
- Надсилає приватне повідомлення користувачу: `Твоє повідомлення видалено: це чат фракції {НАЗВА_ФРАКЦІЇ}. Твоя фракція: {ФРАКЦІЯ_КОРИСТУВАЧА}.`
- Якщо налаштовано загальний чат (`FACTION_CHAT_GENERAL`), надсилає туди повідомлення: `Порушення у чаті {НАЗВА_ФРАКЦІЇ}: {ІМ'Я_КОРИСТУВАЧА} ({ФРАКЦІЯ_КОРИСТУВАЧА}) написав у чужій гілці. Повідомлення видалено.`

**Коли не діє:**
- Користувач пише у своїй фракції
- Користувач не має обраної фракції
- Повідомлення від бота

**Функція:** `handleFactionChatModeration()`

### 2. Загальний груповий чат

**Правило:** У загальній гілці можуть писати всі користувачі, незалежно від фракції.

**Дія бота:** Не застосовує модерацію до повідомлень у загальному чаті (окрім системних обмежень Telegram).

## Порядок перевірок

Бот виконує модерацію у такому порядку:
1. Спочатку перевіряє фракційні чати (`handleFactionChatModeration`)
2. Загальний чат пропускає без модерації

Це означає, що якщо користувач без фракції пише у фракційному чаті, правило для фракційних чатів не спрацьовує, бо немає фракції для порівняння.

## Технічні деталі

### Визначення чату

Бот визначає тип чату за:
- `chat.id` (числовий ID)
- `chat.username` (username чату, якщо є)

Налаштування чатів беруться з змінних середовища:
- `FACTION_CHAT_REAL` — формат: `chat_id` або `@username` або `chat_id:thread_id`
- `FACTION_CHAT_BARCA` — формат: `chat_id` або `@username` або `chat_id:thread_id`
- `FACTION_CHAT_MANCHESTER_UNITED` — формат: `chat_id` або `@username` або `chat_id:thread_id`
- `FACTION_CHAT_GENERAL` — формат: `chat_id` або `@username` або `chat_id:thread_id`

### Визначення фракції користувача

Фракція користувача зберігається у полі `faction_club_id` таблиці `users`:
- `"real-madrid"` — фракція Реал Мадрид
- `"barcelona"` — фракція Барселона
- `null` або відсутнє — фракція не обрана

### Форматування імені користувача

Для відображення використовується функція `formatUserDisplay()`:
- Якщо є `first_name` та `last_name`: `{first_name} {last_name}`
- Якщо є `username`: `@{username}`
- Інакше: `User {id}`

## Приклади сценаріїв

### Сценарій 1: Користувач з Реал пише у чаті Барси
- Повідомлення видаляється
- Користувач отримує: "Твоє повідомлення видалено: це чат фракції БАРСЕЛОНА. Твоя фракція: РЕАЛ МАДРИД."
- У загальний чат надсилається повідомлення про порушення

### Сценарій 2: Користувач без фракції пише у загальному чаті
- Повідомлення залишається без змін
- Модерація не спрацьовує

### Сценарій 3: Користувач з Реал пише у своєму чаті
- Повідомлення залишається без змін
- Модерація не спрацьовує

## Де знаходиться код

- **Функції модерації:** `api/src/handlers.ts`
  - `handleFactionChatModeration()` — модерація фракційних чатів
  - `handleGeneralChatModeration()` — модерація загального чату (зараз не використовується для блокувань)
  - `getFactionChatRefs()` — отримання налаштувань чатів
  - `getUserClassicoChoice()` — отримання фракції користувача з `faction_club_id`
- **Відправка повідомлень:** `api/src/services/telegram.ts`
  - `sendMessage()` — відправка текстового повідомлення
  - `deleteMessage()` — видалення повідомлення
- **Webhook обробка:** `api/src/handlers.ts` → `POST /tg/webhook`
