# Правила поведінки бота у груповому чаті

Цей документ описує всі умови та правила, за якими Telegram-бот модерує груповий чат.

## Структура чатів

Бот працює з трьома типами чатів:
- **Фракційні чати** (гілки обговорень):
  - `FACTION_CHAT_REAL` — чат фракції Реал Мадрид
  - `FACTION_CHAT_BARCA` — чат фракції Барселона
- **Загальний груповий чат**:
  - `FACTION_CHAT_GENERAL` — основний груповий чат

## Правила модерації

### 1. Модерація фракційних чатів

**Умова:** Користувач пише у чаті фракції, до якої він не належить.

**Дія бота:**
- Видаляє повідомлення користувача
- Надсилає приватне повідомлення користувачу: `Твоє повідомлення видалено: це чат фракції {НАЗВА_ФРАКЦІЇ}. Твоя фракція: {ФРАКЦІЯ_КОРИСТУВАЧА}.`
- Якщо налаштовано загальний чат (`FACTION_CHAT_GENERAL`), надсилає туди повідомлення: `Порушення у чаті {НАЗВА_ФРАКЦІЇ}: {ІМ'Я_КОРИСТУВАЧА} ({ФРАКЦІЯ_КОРИСТУВАЧА}) написав у чужій гілці. Повідомлення видалено.`

**Коли не діє:**
- Користувач пише у своїй фракції
- Користувач не має обраної фракції (тоді спрацьовує правило для загального чату)
- Повідомлення від бота

**Функція:** `handleFactionChatModeration()`

### 2. Модерація загального групового чату

**Умова:** Користувач без обраної фракції (`classico_choice` відсутнє або `null`) пише у загальному груповому чаті.

**Дія бота:**
- Видаляє повідомлення користувача
- Надсилає приватне повідомлення користувачу: `Твоє повідомлення видалено: у груповому чаті можуть писати тільки користувачі з обраною фракцією. Оберіть фракцію у WebApp.`
- Надсилає повідомлення у загальний чат: `Порушення у груповому чаті: {ІМ'Я_КОРИСТУВАЧА} написав повідомлення без обраної фракції. Повідомлення видалено.`

**Коли не діє:**
- Користувач має обрану фракцію (`classico_choice === "real_madrid"` або `"barcelona"`)
- Повідомлення від бота
- Повідомлення не у загальному чаті

**Функція:** `handleGeneralChatModeration()`

## Порядок перевірок

Бот виконує модерацію у такому порядку:
1. Спочатку перевіряє фракційні чати (`handleFactionChatModeration`)
2. Потім перевіряє загальний чат (`handleGeneralChatModeration`)

Це означає, що якщо користувач без фракції пише у фракційному чаті, спрацює правило для фракційного чату (але воно не спрацює, бо у користувача немає фракції для порівняння). Тому обидві перевірки виконуються незалежно.

## Технічні деталі

### Визначення чату

Бот визначає тип чату за:
- `chat.id` (числовий ID)
- `chat.username` (username чату, якщо є)

Налаштування чатів беруться з змінних середовища:
- `FACTION_CHAT_REAL` — формат: `chat_id` або `@username` або `chat_id:thread_id`
- `FACTION_CHAT_BARCA` — формат: `chat_id` або `@username` або `chat_id:thread_id`
- `FACTION_CHAT_GENERAL` — формат: `chat_id` або `@username` або `chat_id:thread_id`

### Визначення фракції користувача

Фракція користувача зберігається у полі `classico_choice` таблиці `users`:
- `"real_madrid"` — фракція Реал Мадрид
- `"barcelona"` — фракція Барселона
- `null` або відсутнє — фракція не обрана

### Форматування імені користувача

Для відображення використовується функція `formatUserDisplay()`:
- Якщо є `first_name` та `last_name`: `{first_name} {last_name}`
- Якщо є `username`: `@{username}`
- Інакше: `User {id}`

## Приклади сценаріїв

### Сценарій 1: Користувач з Реал пише у чаті Барси
- Повідомлення видаляється
- Користувач отримує: "Твоє повідомлення видалено: це чат фракції БАРСЕЛОНА. Твоя фракція: РЕАЛ МАДРИД."
- У загальний чат надсилається повідомлення про порушення

### Сценарій 2: Користувач без фракції пише у загальному чаті
- Повідомлення видаляється
- Користувач отримує: "Твоє повідомлення видалено: у груповому чаті можуть писати тільки користувачі з обраною фракцією. Оберіть фракцію у WebApp."
- У загальний чат надсилається повідомлення про порушення

### Сценарій 3: Користувач з Реал пише у своєму чаті
- Повідомлення залишається без змін
- Модерація не спрацьовує

## Де знаходиться код

- **Функції модерації:** `api/src/handlers.ts`
  - `handleFactionChatModeration()` — модерація фракційних чатів
  - `handleGeneralChatModeration()` — модерація загального чату
  - `getFactionChatRefs()` — отримання налаштувань чатів
  - `getUserClassicoChoice()` — отримання фракції користувача
- **Відправка повідомлень:** `api/src/services/telegram.ts`
  - `sendMessage()` — відправка текстового повідомлення
  - `deleteMessage()` — видалення повідомлення
- **Webhook обробка:** `api/src/handlers.ts` → `POST /tg/webhook`
